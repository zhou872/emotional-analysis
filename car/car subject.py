import pandas as pd
from openai import OpenAI
from concurrent.futures import ThreadPoolExecutor, as_completed
from tqdm import tqdm  # 导入tqdm库

# 读取CSV文件
df = pd.read_csv(r"D:\py project\qg\汽车\验证集.csv")

# 初始化OpenAI客户端
client = OpenAI(api_key="YOUR API key", base_url="https://api.deepseek.com")


# 定义一个函数来进行主题分类
def classify_subject(content_id, content):
    try:
        content_id = str(content_id)
        content = str(content)
        message_content = f"ID: {content_id}\n评论内容: {content}"
        response = client.chat.completions.create(
            model="deepseek-reasoner",
            messages=[
                {"role": "system",
                 "content": "你是一个有用的助手，接下来我会提供一个包含汽车行业用户评论的数据集，内容分为content_id, content，你需要对每条评论进行主题分类，分类的结果是这十个主题中的一个，'动力', '价格', '内饰', '配置', '安全性', '外观', '操控', '油耗', '空间', '舒适性'，如在content中发现以上关键词，可大概率就是其主题。在我给出的数据集中，每一个评论内容中可能包含多于一个的主题类型，我希望对这样的评论能返回多个主题。最后在响应末尾用分隔符####返回答案,每个主题之间用空格进行分隔，如：'####价格 安全性'。返回的主题结果是用空格分隔的字符串。"
                            "再读一遍问：{你是一个有用的助手，接下来我会提供一个包含汽车行业用户评论的数据集，内容分为content_id, content，你需要对每条评论进行主题分类，分类的结果是这十个主题中的一个，'动力', '价格', '内饰', '配置', '安全性', '外观', '操控', '油耗', '空间', '舒适性'，如在content中发现以上关键词，可大概率就是其主题。。在我给出的数据集中，每一个评论内容中可能包含多于一个的主题类型，我希望对这样的评论能返回多个主题。最后在响应末尾用分隔符####返回答案,每个主题之间用空格进行分隔，如：'####价格 安全性'。返回的主题结果是用空格分隔的字符串}"
                            
                            "示例："
                            "13149,因为森林人即将换代，这套系统没必要装在一款即将换代的车型上，因为肯定会影响价格。"
                            "评论中 “因为肯定会影响价格” 直接点明了对车辆价格的关注，是整个论述的核心结论。前文 “这套系统没必要装在一款即将换代的车型上” 是对影响价格原因的解释，其最终落脚点仍是价格问题，并未对 “系统” 本身的配置属性（如功能、规格等）进行讨论。所以该评论的主题是 “价格”。"
                            "####价格"
                            
                            "8865,这玩意都是给有钱任性又不懂车的土豪用的，这价格换一次我妹夫EP020可以换三锅了"
                            "评论中 “这价格换一次我妹夫 EP020 可以换三锅了” 直接围绕 “价格” 展开，通过对比更换成本强调对价格的关注，前文 “给有钱任性又不懂车的土豪用” 也是对产品定价和消费群体的评价，核心始终聚焦在 “价格” 上，未涉及其他主题相关内容。所以该评论的主题是 “价格”。"
                            "####价格"
                            
                            "13315,优惠可以了！购进吧！买了不会后悔的！时间可鉴！   "
                            "评论中 “优惠可以了” 直接提到 “优惠”，而优惠是价格相关的重要内容，用户围绕价格优惠表达了购买建议，核心关注点是车辆的价格是否合适，未涉及其他主题相关内容。所以该评论的主题是 “价格”。"
                            "####价格"
                            
                            "7366,来湖北，我上月订的2.0蓝色时尚，优惠1万3送6次保养，本月底提车"
                            "评论中 “优惠 1 万 3 送 6 次保养” 直接围绕购车时的价格优惠展开，“优惠” 是价格主题的核心关键词，用户通过具体数字描述价格优惠力度及附加福利，核心目的是分享购车时的价格相关信息，未涉及其他主题相关内容。所以该评论的主题是 “价格”。"
                            "####价格"
                            
                            "7907,垃圾导航 都不晓得怎么退出  比如听收音，退到主界面还是收音在响，换成USB就能切换过来，到了USB又不知道怎么退出 先天不足啊"
                            "评论核心聚焦于导航系统的功能缺陷，属于汽车配置中的电子系统问题。用户通过具体场景描述（如切换收音 / USB 后无法退出、操作逻辑混乱），指出导航系统的交互设计存在根本性缺陷（“先天不足”），这直接指向车辆配置的合理性与实用性。“垃圾导航” 的负面评价和对系统底层设计的批评，本质上是对车辆电子配置性能的质疑，符合汽车评论中 “配置” 主题的典型特征257。值得注意的是，导航系统作为现代汽车的核心配置之一，其操作逻辑和用户体验直接影响车辆的整体实用性。用户反馈的 “无法退出收音”“切换后仍有声音” 等问题，反映出该配置在功能实现上的缺陷，属于配置主题下的 “功能体验” 子维度410。这种对配置细节的批评，与单纯讨论价格或外观的评论具有本质区别，因此应归类为 “配置” 主题。"
                            "####配置"
                            
                            "12821,说实话，基本上用不上车上导航，用手机更方便！音响效果不用纠结，毕竟不是想成为移动音乐厅。"
                            "评论中 “车上导航” 和 “音响效果” 均指向车辆的具体配置：“基本上用不上车上导航，用手机更方便” 是对车载导航系统实用性的评价，属于对 “配置”（信息娱乐系统）的主观使用感受；“音响效果不用纠结” 是对车载音响配置（音频系统）的直接讨论，认为其性能无需过高期待。尽管用户未直接批评配置缺陷，但核心围绕 “导航” 和 “音响” 这两项具体配置展开，强调个人对其功能价值的判断（如导航不如手机实用、音响无需追求高端），符合 “配置” 主题中对车辆功能配置实用性和用户体验的评价范畴。内容未涉及价格、舒适性等其他主题，因此主题为 “配置”。"
                            "####配置"
                            
                            "1262,石桥这款轮胎是进口的，我记得途虎网上面有，但是有可能要提前预定的。我觉得森林人这款车有条件可以配二套轮胎，日常使用就用石桥的原配胎，走长途自驾马牌ccc系列不错。"
                            "评论围绕轮胎的选择与使用场景展开，核心聚焦于车辆配置的优化建议：轮胎类型与品牌：用户明确提到 “石桥原配胎” 和 “马牌 CCC 系列”，这两款轮胎分别代表原厂配置与第三方升级选项。石桥轮胎的 “进口” 属性和途虎网的购买渠道（需提前预定）属于对轮胎配置来源的说明，而马牌 CCC 系列的推荐则涉及不同品牌轮胎的性能差异312。双轮胎配置方案：用户建议 “有条件可以配二套轮胎”，日常使用原厂胎，长途自驾更换为马牌轮胎。这种 “场景化配置” 策略直接指向车辆配置的灵活性与实用性 —— 通过切换轮胎满足不同驾驶需求（如城市通勤与长途越野），属于典型的配置优化建议14。性能与功能导向：用户未提及轮胎价格或维护成本，而是强调轮胎的适配性（如 “走长途自驾”），隐含对轮胎抓地力、耐磨性等性能的考量。这与轮胎配置中 “根据驾驶环境选择花纹、材质” 的原则一致.综上，评论通过具体轮胎型号推荐和场景化配置方案，展现了对车辆配置合理性的深度思考，符合 “配置” 主题的典型特征。"
                            "####配置"
                            
                            "4737,这玩意我从来没看过，真鸡肋，有倒车影像这个基本没用"
                            "评论核心围绕车载功能的实用性展开：“这玩意” 的指代：结合语境（“有倒车影像这个基本没用”），“这玩意” 应指向车与倒车相关的辅助功能（如倒车雷达、后视镜辅助等），属于车辆配置中的具体功能模块；功能价值否定：用户认为该功能 “鸡肋”，原因是已有 “倒车影像”（另一项配置）使其失去存在意义。这是对两项配置（目标功能与倒车影像）在实际使用中功能重叠性的评价，本质是对配置设计合理性（是否冗余、是否实用）的讨论；配置对比逻辑：通过 “倒车影像” 这一配置的存在，反衬另一配置的无用性，体现用户对车辆配置间功能互补性的判断 —— 若某项配置（如倒车影像）已满足需求，其他相似功能（如传统倒车辅助）可能被视为多余。评论未涉及价格、舒适性等其他主题，而是聚焦于具体配置（辅助驾驶功能）的实用性和功能替代性，符合 “配置” 主题中对车辆功能模块是否必要、是否符合用户需求的评价范畴。"
                            "####配置"
                            
                            "9624,我车25的，刚换完中缸。平时用车是非常满意的，动力足，加速快，安静省油。真的好用。   "
                            "动力足，加速快”直接描述车辆的动力表现，“动力足” 对应 “动力” 主题，“加速快” 是动力性能（如发动机输出、加速能力）的具体体现，属于动力主题的核心评价维度。“省油” 明确指向 “油耗” 主题，是对车辆燃油经济性的正面评价；尽管提到 “刚换完中缸”，但该表述仅说明车辆维护情况，未涉及对中缸本身配置（如性能、规格）的评价，且给定主题中无 “维修” 类别，故不纳入主题分类；核心情感 “非常满意”“真的好用” 围绕动力、油耗的综合体验展开，未涉及价格、外观等其他主题。综上，评论通过 “动力足”“加速快”“省油” 等关键词，分别对应 “动力”“油耗” 三个主题，是对车辆核心性能与使用体验的直接评价。"
                            "####动力 油耗"
                            
                            "9938,主要看上森的水平对置发动机和空间，看这价格真比不了杠五。    "
                            "“水平对置发动机”水平对置发动机是车辆动力系统的核心部件，用户明确将其作为 “主要看上” 的优势，直接指向 “动力” 主题。水平对置发动机的技术特性（如低重心、平顺性）属于动力性能的评价范畴，与发动机类型、性能表现直接相关。“空间”用户直接提及 “空间” 作为另一核心关注点，属于给定主题中的独立维度 “空间”。评论未涉及舒适性（如噪音、座椅软硬等），而是聚焦于车辆的空间表现（如乘坐空间、储物能力等），因此应归类为 “空间” 主题。“价格真比不了杠五”明确对比森林人与 “杠五”（马自达 CX-5）的价格，通过 “比不了” 表达对价格劣势的主观判断，直接对应 “价格” 主题，属于对车辆性价比的评价。评论未涉及 “舒适性”（如静谧性、座椅舒适度等），仅通过 “空间” 直接描述车辆物理空间表现，符合 “空间” 主题的定义（对车内空间大小、实用性的评价）。综上，评论通过 “水平对置发动机”（动力）、“空间”（空间）、“价格”（价格）三个明确关键词，分别对应给定主题中的三个独立维度，逻辑上无需额外引申或归类至其他主题。"
                            "####动力 空间 价格"
                            
                            "148,我也是这样，瘦小的人坐在森的座椅上毫无包裹感，我开一个小时以上就腰疼，所以我买个一个记忆腰靠"
                            "“座椅上毫无包裹感”直接描述座椅的人体工程学设计问题，“包裹感” 是座椅舒适性的核心评价指标，反映座椅对身体的支撑和贴合度，属于 “舒适性” 主题下 “座椅舒适性” 的子维度。“开一个小时以上就腰疼”进一步说明座椅设计缺陷导致的使用体验问题，长时间驾驶后的腰部不适是典型的舒适性不足表现，与座椅材质、支撑结构直接相关，而非空间（如腿部空间）或配置（如是否配备腰托调节）的客观描述，而是主观舒适感受。“买个记忆腰靠”补充说明通过外部辅助工具改善舒适性，间接印证原车座椅在舒适性设计上的不足，核心诉求仍是解决 “坐感不适” 的问题，未涉及对座椅材质（内饰）或调节功能（配置）的评价，仅聚焦舒适体验。综上，评论围绕座椅的包裹感和长时间乘坐的腰部不适展开，所有描述均指向 “舒适性” 这一核心主题，未涉及空间、配置、内饰等其他主题关键词。"
                            "####舒适性"
                            
                            "9311,空间倒无所谓大多数都是我一个人，我对空间没什么要求。没有全景天窗很可惜，xv有种不上不下的感觉。外观我觉得很一般。屁股很不喜欢，可能是因为短    "
                            "评论内容中，“空间倒无所谓大多数都是我一个人，我对空间没什么要求” 明确提及了 “空间”，表明涉及该主题；“没有全景天窗很可惜”，全景天窗属于汽车配置的一部分，对应 “配置” 主题；“外观我觉得很一般。屁股很不喜欢，可能是因为短”，直接提到了对汽车 “外观” 的评价。所以该评论包含的主题为 “空间”“配置”“外观”。"
                            "####空间 配置 外观"
                            
                            "3069,你的刹车片是用什么牌子的，多少钱。那里买。原厂比较贵要2500元，是真的吗？   "
                            "评论内容围绕刹车片展开询问，虽提及了刹车片牌子，但核心聚焦在 “多少钱”“原厂比较贵要 2500 元” 上，整个对话的关键在于获取刹车片的价格信息以及确认价格的真实性，“牌子” 只是引出价格问题的一个背景。因此，此评论主要涉及的主题是 “价格”"
                            "####价格"
                            
                            "13603,特装确实不错，配置很实用"
                            "评论中明确提到 “配置很实用”，直接指出了对汽车配置方面的肯定，内容里未涉及其他主题相关的表述。所以该评论的主题是 “配置”"
                            "####配置"
                            
                            "7424,我的小森虽然是20的，感觉油门很灵敏，起步时稍微点一下油门就窜出去了"
                            "评论中提到 “油门很灵敏，起步时稍微点一下油门就窜出去了”，油门的灵敏程度以及车辆起步的反应都与汽车的动力性能紧密相关。油门作为控制发动机动力输出的关键部件，其灵敏性直接影响着车辆动力的释放和响应速度，所以该评论的主题是 “动力”"
                            "####动力"
                            
                            "1790,没有大事故，就是内饰有些旧！需要回来重新搞！谢谢！"
                            "评论中明确指出 “内饰有些旧”，并且表达了要对其进行重新处理的想法，整个内容聚焦于汽车的内饰状况，未涉及其他主题相关信息。所以该评论的主题是 “内饰”。"
                            "####内饰"
                            
                            "17134,有人追求安全可靠抵达，有人追求比赛刺激，需求不同，我是前者"
                            "评论中提到 “有人追求安全可靠抵达，有人追求比赛刺激，需求不同，我是前者”，“安全可靠抵达” 体现了对汽车在行驶过程中保障安全这一性能的关注，而这与汽车的 “安全性” 主题相契合，内容未涉及其他主题相关内容。所以该评论的主题是 “安全性”。"
                            "####安全性"
                            
                            "15373, 如果提速是楼主最关心的问题 建议还是20t AT吧 25 CVT组合还是舒适操控为主"
                            "评论中“25 CVT组合还是舒适操控为主”直接点明了该变速箱组合的特点是围绕“操控”展开，强调其操控属性；而“提速是楼主最关心的问题”仅是引出建议的背景，并未对动力性能本身进行评价或讨论，核心在于通过不同配置组合的特点给出关于“操控”的建议。所以该评论包含的主题为“操控”。"
                            "####操控"
                            
                            "11301,没有任何问题啊，油耗也没增加，一切正常。现在在八千公里左右换机油。"
                            "评论中“油耗也没增加”直接提及“油耗”，明确对应主题“油耗”；“八千公里左右换机油”属于车辆保养相关内容，而给定的主题分类中并无保养相关类别，因此无需纳入主题分类。所以该评论的主题是“油耗”。"
                            "####油耗"
                            
                            "8650,这东西装上了高速噪音会很大吧"
                            "评论中“高速噪音会很大吧”表达了对车辆高速行驶时噪音问题的担忧，而噪音水平是影响乘坐“舒适性”的重要因素，属于舒适性主题下对车辆静谧性的评价，内容未涉及其他主题相关关键词。所以该评论的主题是“舒适性”。"
                            "####舒适性"
                            
                            "16859,这个是高速空气扰流，减少噪音的"
                            "评论中 “减少噪音” 体现了对车辆行驶时噪音控制效果的关注，而噪音水平是影响乘坐 “舒适性” 的重要因素，属于舒适性主题下对车辆静谧性的评价。“高速空气扰流” 描述的是实现噪音减少的技术手段，其核心目的和最终指向是提升乘坐舒适性，并非对汽车外观设计或配置本身进行评价，因此该评论的主题是 “舒适性”。"
                            "####舒适性"
                            
                            "3904,异响能解决吗？车漆能硬点吗？前档玻璃能结实点吗？"
                            "评论中“异响能解决吗？”体现了对车辆噪音问题的关注，噪音水平是影响乘坐“舒适性”的重要因素；“车漆能硬点吗？”针对车身漆面质量，属于“外观”主题；“前档玻璃能结实点吗？”关注玻璃的材质和性能，前档玻璃作为车辆的重要部件，其结实程度属于“配置”主题（配置包含零部件的具体规格和功能）。所以该评论包含的主题为“舒适性”“外观”“配置”。"
                            "####舒适性 外观 配置"
                 },
                {"role": "user", "content": f"你是一个有用的助手，接下来我会提供一个包含汽车行业用户评论的数据集，内容分为content_id, content，你需要对每条评论进行主题分类，分类的结果是这十个主题中的一个，'动力', '价格', '内饰', '配置', '安全性', '外观', '操控', '油耗', '空间', '舒适性'，如在content中发现以上关键词，可大概率就是其主题。在我给出的数据集中，每一个评论内容中可能包含多于一个的主题类型，我希望对这样的评论能返回多个主题。最后在响应末尾用分隔符####返回答案,每个主题之间用空格进行分隔，如：'####价格 安全性'。返回的主题结果是用空格分隔的字符串。内容：{content}"},
            ],
            stream=False
        )
        response_content = response.choices[0].message.content.strip()

        # 找到####的位置
        separator_position = response_content.find("####")

        # 提取####后的所有关键词
        predicted_subject = response_content[separator_position + 4:].strip()

        valid_subjects = {'动力', '价格', '内饰', '配置', '安全性', '外观', '操控', '油耗', '空间', '舒适性'}

        # 对返回的主题进行拆分
        subjects = predicted_subject.split()
        results = []
        for subject in subjects:
            if subject in valid_subjects:
                results.append((content_id, content, subject, True))
            else:
                print(f"{content_id}异常返回值: {subject}。")
                results.append((content_id, content, subject, False))
        return results

    except Exception as e:
        # 打印错误信息或记录错误日志
        print(f"Error in classifying comment ID {content_id}: {e}")
        # 返回默认值，例如'未知'
        return [(content_id, content, "未知", False)]


# 使用ThreadPoolExecutor进行多线程处理
all_results = []
with ThreadPoolExecutor(max_workers=8) as executor:  # max_workers可以根据你的CPU核心数和网络条件调整
    future_to_news = {executor.submit(classify_subject, content_id, content): (content_id, content) for
                      content_id, content in df[['content_id', 'content']].values}
    for future in tqdm(as_completed(future_to_news), total=len(future_to_news), desc="处理评论", unit="条"):
        content_id, content = future_to_news[future]
        try:
            results = future.result()
            all_results.extend(results)
        except Exception as exc:
            print(f'ID: {content_id} 生成异常: {exc}')
            all_results.append((content_id, content, "未知", False))

# 分离两类数据
valid_results = [r[:3] for r in all_results if r[3]]  # 只保留前三个元素
invalid_results = [r[:3] for r in all_results if not r[3]]  # 只保留前三个元素

# 保存到CSV文件
valid_df = pd.DataFrame(valid_results, columns=['content_id', 'content', 'subject'])
invalid_df = pd.DataFrame(invalid_results, columns=['content_id', 'content', 'subject'])

valid_df.to_csv(r"D:\py project\qg\汽车\有效验证集.csv", index=False)
invalid_df.to_csv(r"D:\py project\qg\汽车\无效验证集.csv", index=False)
